# Logging & Video Recording Setup Guide

## Overview

This guide explains the structured logging and video recording setup for the Naukri automation project. The implementation includes:

- ✅ **Structured logging** with daily rotating log files
- ✅ **Video recording** for every automation run
- ✅ **Automated cleanup** of old videos (weekly)
- ✅ **PM2 integration** with custom log management
- ✅ **Execution tracking** with unique IDs and duration metrics

---

## Directory Structure

After setup, your project will have:

```
naukriByMe/
├── logs/                           # Application logs directory
│   ├── combined-YYYY-MM-DD.log    # All logs (info, warn, error)
│   ├── error-YYYY-MM-DD.log       # Error logs only
│   ├── execution-YYYY-MM-DD.log   # Execution summaries
│   ├── exceptions-YYYY-MM-DD.log  # Uncaught exceptions
│   ├── rejections-YYYY-MM-DD.log  # Unhandled promise rejections
│   ├── pm2-out.log                # PM2 stdout logs
│   └── pm2-error.log              # PM2 stderr logs
├── videos/                         # Video recordings directory
│   └── *.webm                     # Playwright video recordings
└── scripts/
    └── utils/
        ├── logger.js              # Centralized logger utility
        └── cleanup-videos.js      # Video cleanup utility
```

---

## Configuration

### Environment Variables

Add these to your `.env` file (already added to `example.env`):

```bash
# Log retention period (default: 14 days)
LOG_RETENTION_DAYS=14

# Video retention period (default: 7 days)
VIDEO_RETENTION_DAYS=7
```

### Features

1. **Daily Log Rotation**: Logs rotate daily with date-based filenames
2. **Automatic Cleanup**: Old logs deleted after `LOG_RETENTION_DAYS`
3. **JSON Format**: Logs stored in JSON format for easy parsing
4. **Console Output**: Human-readable colored output in development
5. **Execution Tracking**: Each run gets a unique execution ID
6. **Video Recording**: All runs recorded as WebM videos (1280x720)
7. **Weekly Video Cleanup**: Runs every Monday at 2 AM IST

---

## Logging Levels

The logger supports standard Winston log levels:

- `error`: Error events that might still allow the application to continue
- `warn`: Warning messages
- `info`: Informational messages (default level)
- `debug`: Detailed debug information (set `LOG_LEVEL=debug` in `.env`)

### Log Format

**Console Output** (human-readable):
```
2025-11-18 14:30:00 [info]: Starting Naukri automation {"executionId":"exec-1731929400000-abc123","headless":false}
```

**File Output** (JSON):
```json
{
  "timestamp": "2025-11-18 14:30:00",
  "level": "info",
  "message": "Starting Naukri automation",
  "executionId": "exec-1731929400000-abc123",
  "headless": false
}
```

---

## Execution Summary Logs

Every automation run generates an execution summary in `logs/execution-YYYY-MM-DD.log`:

**Successful Run**:
```json
{
  "timestamp": "2025-11-18 14:35:23",
  "level": "info",
  "message": "Execution Summary",
  "executionId": "exec-1731929400000-abc123",
  "success": true,
  "action": "added",
  "location": "Kolkata",
  "duration": "5m 23s",
  "durationMs": 323000,
  "sessionReused": true
}
```

**Failed Run**:
```json
{
  "timestamp": "2025-11-18 14:35:23",
  "level": "info",
  "message": "Execution Summary",
  "executionId": "exec-1731929400000-abc123",
  "success": false,
  "action": "",
  "location": "Kolkata",
  "duration": "2m 15s",
  "durationMs": 135000,
  "error": "Login might have failed or took too long.",
  "stack": "Error: Login might have failed..."
}
```

---

## Video Recording

### Configuration

Videos are automatically recorded for **every automation run**:

- **Format**: WebM (Playwright default)
- **Resolution**: 1280x720
- **Location**: `videos/` directory
- **Naming**: Auto-generated by Playwright (UUID-based)
- **Retention**: Configurable via `VIDEO_RETENTION_DAYS` (default: 7 days)

### Cleanup Schedule

Videos older than `VIDEO_RETENTION_DAYS` are automatically deleted:

- **Schedule**: Every Monday at 2:00 AM IST
- **Utility**: `scripts/utils/cleanup-videos.js`
- **Logging**: Cleanup statistics logged to application logs

### Manual Cleanup

Run video cleanup manually:

```bash
node scripts/utils/cleanup-videos.js
```

---

## PM2 Configuration

### Current Setup

`ecosystem.config.js` now includes:

```javascript
{
  name: 'scheduler',
  script: 'scripts/scheduler.js',
  // Custom log paths
  out_file: 'logs/pm2-out.log',
  error_file: 'logs/pm2-error.log',
  // Log formatting
  log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
  merge_logs: true,
  log_type: 'json',
  // Memory management
  max_memory_restart: '500M',
  // Auto-restart settings
  autorestart: true,
  restart_delay: 5000,
  max_restarts: 10
}
```

### PM2 Log Rotation (Optional but Recommended)

PM2 logs (`pm2-out.log` and `pm2-error.log`) don't auto-rotate. Install `pm2-logrotate` module:

#### Installation

```bash
# Install pm2-logrotate globally
pm2 install pm2-logrotate
```

#### Configuration

```bash
# Set max log file size (default: 10MB)
pm2 set pm2-logrotate:max_size 10M

# Set retention (default: 30 files)
pm2 set pm2-logrotate:retain 30

# Set compression (default: false)
pm2 set pm2-logrotate:compress true

# Set rotation interval (daily)
pm2 set pm2-logrotate:rotateInterval '0 0 * * *'
```

#### Verify Configuration

```bash
pm2 conf pm2-logrotate
```

---

## PM2 Commands

### Start/Restart the Scheduler

```bash
# Start the scheduler
pm2 start ecosystem.config.js

# Restart after code changes
pm2 restart scheduler

# Reload configuration
pm2 reload scheduler
```

### View Logs

```bash
# View all logs (live tail)
pm2 logs scheduler

# View last 100 lines
pm2 logs scheduler --lines 100

# View error logs only
pm2 logs scheduler --err

# View specific log file
tail -f logs/combined-$(date +%Y-%m-%d).log
```

### Check Status

```bash
# List all PM2 processes
pm2 list

# Detailed info about scheduler
pm2 show scheduler

# Monitor CPU/Memory in real-time
pm2 monit
```

### Stop/Delete

```bash
# Stop the scheduler
pm2 stop scheduler

# Delete from PM2 process list
pm2 delete scheduler
```

---

## Testing Locally

### Test Logging

Run the scheduler directly to test logging:

```bash
# Set up your .env file first
cp example.env .env
# Edit .env with your credentials

# Run scheduler (will wait for scheduled time)
node scripts/scheduler.js
```

### Test Automation with Logging

Run the automation script directly:

```bash
node scripts/naukri-automation.js
```

Check the `logs/` directory for generated log files.

### Test Video Cleanup

```bash
# Run cleanup manually
node scripts/utils/cleanup-videos.js

# Check cleanup logs
cat logs/combined-$(date +%Y-%m-%d).log | grep "cleanup"
```

---

## Checking Logs on VPS

### Daily Log Files

```bash
# View today's combined logs
cat logs/combined-$(date +%Y-%m-%d).log

# View today's errors only
cat logs/error-$(date +%Y-%m-%d).log

# View today's execution summaries
cat logs/execution-$(date +%Y-%m-%d).log

# Search for specific execution ID
grep "exec-1731929400000-abc123" logs/combined-*.log
```

### Filter Logs with jq

```bash
# View all successful executions today
cat logs/execution-$(date +%Y-%m-%d).log | jq 'select(.success == true)'

# View all failed executions
cat logs/execution-*.log | jq 'select(.success == false)'

# Get execution duration statistics
cat logs/execution-*.log | jq '.durationMs' | awk '{sum+=$1; count++} END {print "Avg:", sum/count, "ms"}'
```

### PM2 Logs

```bash
# View PM2 logs
pm2 logs scheduler --lines 50

# View PM2 log files directly
tail -f logs/pm2-out.log
tail -f logs/pm2-error.log
```

---

## Troubleshooting

### No Logs Generated

1. Check if `logs/` directory exists and is writable:
   ```bash
   ls -la logs/
   ```

2. Check environment variables:
   ```bash
   node -e "require('dotenv').config(); console.log(process.env.LOG_RETENTION_DAYS)"
   ```

3. Run script directly to see console output:
   ```bash
   node scripts/naukri-automation.js
   ```

### Videos Not Recorded

1. Check if `videos/` directory exists:
   ```bash
   ls -la videos/
   ```

2. Verify Playwright is installed:
   ```bash
   npx playwright --version
   ```

3. Check if video recording is enabled in script (it should be by default now)

### PM2 Logs Not Rotating

1. Verify `pm2-logrotate` is installed:
   ```bash
   pm2 list
   # Should show "pm2-logrotate" in the list
   ```

2. Check configuration:
   ```bash
   pm2 conf pm2-logrotate
   ```

3. Manually trigger rotation:
   ```bash
   pm2 flush scheduler
   ```

---

## Log Analysis Tips

### Check Automation Success Rate

```bash
# Count successful vs failed executions
cat logs/execution-*.log | jq -r '.success' | sort | uniq -c
```

### Find Recent Errors

```bash
# Last 10 errors with timestamps
tail -n 10 logs/error-$(date +%Y-%m-%d).log | jq '.'
```

### Track Video Cleanup Stats

```bash
# View cleanup summaries
cat logs/combined-*.log | jq 'select(.message == "Video cleanup completed")'
```

### Monitor Execution Duration

```bash
# Find slowest executions
cat logs/execution-*.log | jq 'select(.success == true) | {executionId, duration, durationMs}' | jq -s 'sort_by(.durationMs) | reverse | .[0:5]'
```

---

## Storage Management

### Disk Usage

Check storage usage:

```bash
# Logs directory size
du -sh logs/

# Videos directory size
du -sh videos/

# Total project size
du -sh .
```

### Manual Cleanup

If you need to free up space immediately:

```bash
# Delete old log files (older than 30 days)
find logs/ -name "*.log" -type f -mtime +30 -delete

# Delete old videos (older than 7 days)
find videos/ -name "*.webm" -type f -mtime +7 -delete
```

---

## Future Enhancements (Not Implemented)

1. **Email Notifications**: Send alerts on automation failures
2. **Metrics Dashboard**: Visualize execution statistics
3. **Log Aggregation**: Push logs to centralized logging service (e.g., Logstash, Datadog)
4. **Video Compression**: Compress videos before storage to save space
5. **Backup to Cloud**: Auto-backup videos/logs to S3 or similar

---

## Summary

✅ **What You Get:**
- Daily rotating log files with automatic cleanup
- JSON-formatted logs for easy parsing
- Execution summaries for every automation run
- Video recording for all runs (not just failures)
- Automated weekly video cleanup
- PM2 integration with custom log management
- Unique execution IDs for tracking
- Duration metrics for performance monitoring

✅ **What You Need to Do:**
1. Copy `example.env` to `.env` and configure variables
2. Install `pm2-logrotate` module (optional but recommended)
3. Start scheduler with `pm2 start ecosystem.config.js`
4. Check logs in `logs/` directory to verify automation runs

✅ **On VPS:**
- Simply check `logs/combined-YYYY-MM-DD.log` for today's activity
- Videos saved in `videos/` (auto-cleaned weekly)
- PM2 logs in `logs/pm2-out.log` and `logs/pm2-error.log`
