name: Naukri Automation

on:
  # Manual trigger - run on demand from GitHub Actions tab
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running'
        required: false
        default: 'Manual trigger'
  
  # Scheduled run - runs daily at 9 AM IST (3:30 AM UTC)
  schedule:
    - cron: '30 3 * * *'  # Adjust time as needed

jobs:
  automate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Create .env file
        run: |
          echo "USER_EMAIL=${{ secrets.USER_EMAIL }}" >> .env
          echo "USER_PASSWORD=${{ secrets.USER_PASSWORD }}" >> .env
          echo "NAUKRI_URL=${{ secrets.NAUKRI_URL }}" >> .env
          echo "PROXY_USERNAME=${{ secrets.PROXY_USERNAME }}" >> .env
          echo "PROXY_PASSWORD=${{ secrets.PROXY_PASSWORD }}" >> .env
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
      
      - name: Verify secrets
        run: |
          node -e "const required=['USER_EMAIL','USER_PASSWORD','PROXY_USERNAME','PROXY_PASSWORD'];let missing=false;required.forEach(key=>{const value=process.env[key];if(!value){console.error(`[Secrets] Missing ${key}; failing fast.`);missing=true;}else{console.log(`[Secrets] ${key} loaded (length ${value.length}).`);}});if(missing){process.exit(1);}['NAUKRI_URL','TELEGRAM_BOT_TOKEN','TELEGRAM_CHAT_ID'].forEach(key=>{const value=process.env[key];if(value){console.log(`[Secrets] ${key} loaded (length ${value.length}).`);}else{console.log(`[Secrets] ${key} not provided (optional).`);}});"
        env:
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
          NAUKRI_URL: ${{ secrets.NAUKRI_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      - name: Run Naukri automation
        run: npm run automate
        continue-on-error: true
      
      - name: Upload logs (if available)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-logs-${{ github.run_number }}
          path: |
            *.log
            screenshots/
          if-no-files-found: ignore
          retention-days: 7
