name: Naukri Automation

on:
  # Manual trigger - run on demand from GitHub Actions tab
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running'
        required: false
        default: 'Manual trigger'
  
  # Scheduled runs - daily at 8:30 AM IST (03:00 UTC) and 11:30 AM IST (06:00 UTC)
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 6 * * *'

jobs:
  automate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Setup virtual display (Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          # Start Xvfb on display :99 with 1920x1080 resolution
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          # Wait for Xvfb to start
          sleep 2
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "âœ… Virtual display started on :99 - headed mode enabled"
      
      - name: Create .env file
        run: |
          echo "USER_EMAIL=${{ secrets.USER_EMAIL }}" >> .env
          echo "USER_PASSWORD=${{ secrets.USER_PASSWORD }}" >> .env
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
          # Add CV secrets if they exist (up to 5 CVs)
          [ -n "${{ secrets.CV_FILE_1_BASE64 }}" ] && echo "CV_FILE_1_BASE64=${{ secrets.CV_FILE_1_BASE64 }}" >> .env
          [ -n "${{ secrets.CV_FILE_1_EXT }}" ] && echo "CV_FILE_1_EXT=${{ secrets.CV_FILE_1_EXT }}" >> .env
          [ -n "${{ secrets.CV_FILE_2_BASE64 }}" ] && echo "CV_FILE_2_BASE64=${{ secrets.CV_FILE_2_BASE64 }}" >> .env
          [ -n "${{ secrets.CV_FILE_2_EXT }}" ] && echo "CV_FILE_2_EXT=${{ secrets.CV_FILE_2_EXT }}" >> .env

      - name: Verify secrets
        run: |
          node <<'NODE'
          const required = ['USER_EMAIL', 'USER_PASSWORD'];
          let missing = false;
          required.forEach(key => {
            const value = process.env[key];
            if (!value) {
              console.error(`[Secrets] Missing ${key}; failing fast.`);
              missing = true;
            } else {
              console.log(`[Secrets] ${key} loaded (length ${value.length}).`);
            }
          });
          if (missing) {
            process.exit(1);
          }
          ['TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID'].forEach(key => {
            const value = process.env[key];
            if (value) {
              console.log(`[Secrets] ${key} loaded (length ${value.length}).`);
            } else {
              console.log(`[Secrets] ${key} not provided (optional).`);
            }
          });
          // Check for CV secrets
          let cvCount = 0;
          for (let i = 1; i <= 10; i++) {
            const cvKey = `CV_FILE_${i}_BASE64`;
            if (process.env[cvKey]) {
              cvCount++;
              console.log(`[Secrets] ${cvKey} loaded (${(process.env[cvKey].length / 1024).toFixed(2)} KB base64).`);
            }
          }
          if (cvCount === 0) {
            console.log('[Secrets] No CV files found (optional). CV upload will be skipped.');
          } else {
            console.log(`[Secrets] Found ${cvCount} CV file(s) for random selection.`);
          }
          NODE
        env:
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CV_FILE_1_BASE64: ${{ secrets.CV_FILE_1_BASE64 }}
          CV_FILE_1_EXT: ${{ secrets.CV_FILE_1_EXT }}
          CV_FILE_2_BASE64: ${{ secrets.CV_FILE_2_BASE64 }}
          CV_FILE_2_EXT: ${{ secrets.CV_FILE_2_EXT }}
          CV_FILE_3_BASE64: ${{ secrets.CV_FILE_3_BASE64 }}
          CV_FILE_3_EXT: ${{ secrets.CV_FILE_3_EXT }}
          CV_FILE_4_BASE64: ${{ secrets.CV_FILE_4_BASE64 }}
          CV_FILE_4_EXT: ${{ secrets.CV_FILE_4_EXT }}
          CV_FILE_5_BASE64: ${{ secrets.CV_FILE_5_BASE64 }}
          CV_FILE_5_EXT: ${{ secrets.CV_FILE_5_EXT }}
      
      - name: Run Naukri automation
        run: npm run automate
        continue-on-error: true
      
      - name: Upload logs (if available)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-logs-${{ github.run_number }}
          path: |
            *.log
            screenshots/
            videos/
          if-no-files-found: ignore
          retention-days: 7
